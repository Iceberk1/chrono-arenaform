<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Chrono</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background-color: #fafafa;
    color: #333;
  }
	header {
	  width: 100%;
	  background: #D63138; /* fond rouge global */
	  color: white;
	  padding: 10px 20px;
	  display: flex;                /* mise en ligne */
	  top: 0;
	  justify-content: space-between; /* espace entre logos et titre */
	  align-items: center;          /* alignement vertical */
	  box-sizing: border-box;
	}

	header h1 {
		display: inline-block;
		font-size: 3em;
		margin: 0;
		vertical-align: top;
		text-align: center;
	}

	.logo-box {
	  background: white;     /* fond blanc autour des logos */
	  padding: 5px 10px;     /* un peu d‚Äôespace */
	  border-radius: 8px;    /* coins arrondis */
	  display: flex;
	  align-items: center;
	  gap: 15px;
	}

	.logo-box img {
	  height: 60px;
	}
  h1 {
    font-size: 3em;
    margin: 10px 0;
  }
  #message {
    font-size: 1.6em;
    text-align: center;
    margin: 20px;
  }
  form {
    max-width: 600px;
    margin: 0 auto 20px auto;
    padding: 20px;
    font-size: 1.6em;
  }
  label {
    font-size: 1.4em;
    display: block;
    margin-bottom: 10px;
  }
  select {
    width: 100%;
    font-size: 1.3em;
    padding: 12px;
    margin-bottom: 20px;
    border: 1px solid #ccc;
    border-radius: 8px;
  }
  #time {
    font-size: 7em;
    text-align: center;
    margin: 40px 0;
  }
  .btn-top {
    text-align: center;
    margin-bottom: 30px;
  }
  .btn-top button {
    font-size: 2.5em;
    padding: 30px 60px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: white;
  }
  #startStopBtn { background-color: green; }
  #startStopBtn:hover { background-color: darkgreen; }

  .btn-bottom {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 50px;
  }
  .btn-bottom button {
    font-size: 2em;
    padding: 20px 40px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: white;
  }
  #resetBtn { background-color: gray; }
  #resetBtn:hover { background-color: #555; }
  #saveBtn { background-color: blue; }
  #saveBtn:hover { background-color: darkblue; }

	.footer {
		position: fixed; /* plus de fixed */
		bottom: 0px;
		width: 100%;
		background: #D63138;
		color: white;
		padding: 15px 0;
		text-align: center;
		font-size: 1.5em;
		box-shadow: 0 -2px 8px rgba(0,0,0,0.2);
	}

  .footer a {
    margin: 0 30px;
    text-decoration: none;
    color: white;
    font-weight: bold;
  }
  .footer a:hover {
    text-decoration: underline;
	
	}
	
	#candidateSearch {
		display: block;
		width: 100%;
		font-size: 1.3em;
		padding: 12px;
		margin-bottom: 10px; /* un peu moins que le select pour l‚Äôespacement */
		border: 1px solid #ccc;
		border-radius: 8px;
		box-sizing: border-box;
	}

</style>
</head>
<body>
	<header>
		<div class="logo-box">
			<img src="/static/arenaform-logo.png" alt="Arenaform Logo">
		</div>
		<h1>Chrono</h1>
		<div class="logo-box">
			<img src="/static/logo-decathlon_blue_exclusion-zone.svg" alt="Decathlon Logo">
		</div>
	</header>
	
	<div id="message" style="color: green;">
	  {{ message }}
	</div>
		
	<form>
	  <input type="text" id="candidateSearch" placeholder="Num√©ro, pr√©nom ou nom">
	  
	  <select id="candidate">
		{% for c in candidates %}
		  <option value="{{ c[0] }}">{{ c[0] }} - {{ c[1] }} {{ c[2] }}</option>
		{% endfor %}
	  </select>

	  <select id="circuit" onchange="toggleTouches()">
		<option value="1">Circuit Ninja</option>
		<option value="2">Circuit Crossfit/Hyrox</option>
		<option value="3">Circuit Pr√©cision</option>
		<option value="4">D√©fi suspension</option>
	  </select>

	  <!-- Touche r√©ussies uniquement pour circuit 3 -->
	  <div id="touchesDiv" style="display:none;">
		<label for="touches">√âl√©ments r√©ussis (0-5) :</label>
		<select id="touches">
		  {% for i in range(0,6) %}
			<option value="{{ i }}">{{ i }}</option>
		  {% endfor %}
		</select>
	  </div>
	</form>

	<script>
	  const candidateSelect = document.getElementById("candidate");
	  const candidateSearch = document.getElementById("candidateSearch");

	  candidateSearch.addEventListener("input", function() {
		const query = this.value.trim().toLowerCase();
		if (!query) return;

		let found = false;

		for (let option of candidateSelect.options) {
		  const [id, ...rest] = option.textContent.toLowerCase().split(" - ");
		  const name = rest.join(" ");

		  // Match par num√©ro exact
		  if (id === query) {
			candidateSelect.value = option.value;
			found = true;
			break;
		  }

		  // Match pr√©nom/nom partiel
		  if (name.includes(query)) {
			candidateSelect.value = option.value;
			found = true;
			break;
		  }
		}
	  });

	  // --- Ton code circuit inchang√© ---
	  const circuitMap = {
		'ninja': '1',
		'crossfit': '2',
		'precision': '3',
		'suspension': '4'
	  };

	  const urlParams = new URLSearchParams(window.location.search);
	  const forcedCircuitName = urlParams.get('circuit');

	  if (forcedCircuitName && circuitMap[forcedCircuitName]) {
		const select = document.getElementById('circuit');
		select.value = circuitMap[forcedCircuitName];
		select.disabled = true;
		toggleTouches();
	  }
	</script>


	<h2 id="time">00:00.00</h2>

	<div class="btn-top">
	  <button type="button" onclick="startStop()" id="startStopBtn">Start</button>
	</div>

	<div class="btn-bottom">
	  <button type="button" onclick="resetTimer()" id="resetBtn">Reset</button>
	  <button type="button" onclick="save()" id="saveBtn" disabled>Enregistrer</button>
	</div>

	<div class="footer">
	  <a href="/add_candidate">‚ûï Ajouter un candidat</a>
	  <a href="/results">üèÜ Voir les r√©sultats</a>
	</div>

	<script>
	let running = false;
	let startTime = 0;
	let elapsed = 0;
	let timer;

	function updateDisplay() {
		let current = elapsed;
		if (running) current += Date.now() - startTime;
		let totalHundredths = Math.floor(current / 10);
		let minutes = Math.floor(totalHundredths / 6000);
		let seconds = Math.floor((totalHundredths % 6000) / 100);
		let hundredths = totalHundredths % 100;
		document.getElementById('time').textContent =
		  `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}.${String(hundredths).padStart(2,'0')}`;
	}

	function startStop() {
		if (running) {
			elapsed += Date.now() - startTime;
			running = false;
			clearInterval(timer);
			document.getElementById('startStopBtn').textContent = 'Start';
			document.getElementById('startStopBtn').style.backgroundColor = 'green';
			document.getElementById('saveBtn').disabled = false;
		} else {
			startTime = Date.now();
			running = true;
			timer = setInterval(updateDisplay, 10);
			document.getElementById('startStopBtn').textContent = 'Stop';
			document.getElementById('startStopBtn').style.backgroundColor = 'red';
			document.getElementById('saveBtn').disabled = true;
		}
	}

	function resetTimer() {
		running = false;
		elapsed = 0;
		clearInterval(timer);
		document.getElementById('time').textContent = '00:00.00';
		document.getElementById('startStopBtn').textContent = 'Start';
		document.getElementById('startStopBtn').style.backgroundColor = 'green';
		document.getElementById('saveBtn').disabled = true;
	}

	async function save() {
		let number = document.getElementById('candidate').value;
		let circuit = document.getElementById('circuit').value;
		let time = elapsed / 1000;
		let touches = (circuit == "3") ? parseInt(document.getElementById('touches').value) : 0;

		let response = await fetch('/save_time', {
			method: 'POST',
			headers: {'Content-Type': 'application/json'},
			body: JSON.stringify({ number, circuit, time, touches })
		});

		// üöÄ Si le serveur a redirig√©, on recharge la page avec la bonne URL
		if (response.redirected) {
			window.location.href = response.url;
		}
	}



	function toggleTouches() {
		let circuit = document.getElementById('circuit').value;
		let touchesDiv = document.getElementById('touchesDiv');
		touchesDiv.style.display = (circuit == "3") ? "block" : "none";
	}

	</script>

</body>
</html>
